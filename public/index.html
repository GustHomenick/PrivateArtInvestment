<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>匿名艺术品投资平台 - 隐私艺术收藏投资</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 0;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .card h3 {
            color: #5a67d8;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4a5568;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        .status.info {
            background: #bee3f8;
            color: #2a4365;
            border: 2px solid #63b3ed;
        }

        .artwork-gallery {
            grid-column: 1 / -1;
            margin-top: 30px;
        }

        .artworks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .artwork-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .artwork-card:hover {
            transform: translateY(-5px);
        }

        .artwork-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #f0f2f5, #e2e8f0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-size: 3em;
        }

        .artwork-info {
            padding: 20px;
        }

        .artwork-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2d3748;
        }

        .artwork-artist {
            color: #718096;
            margin-bottom: 15px;
        }

        .artwork-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-weight: bold;
            color: #5a67d8;
        }

        .stat-label {
            color: #718096;
        }

        .invest-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .invest-btn:hover {
            transform: translateY(-1px);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab:first-child {
            border-radius: 10px 0 0 10px;
        }

        .tab:last-child {
            border-radius: 0 10px 10px 0;
        }

        .tab.active {
            background: #5a67d8;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            color: white;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 14px;
        }

        .connected {
            background: rgba(72, 187, 120, 0.8);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">未连接</div>

    <div class="container">
        <div class="header">
            <h1>🎨 匿名艺术品投资平台</h1>
            <p>隐私保护的艺术收藏品投资，基于FHE同态加密技术</p>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 0.9em;">
                <strong>🔐 FHE隐私保护特性：</strong>
                <br>• 投资金额完全加密存储
                <br>• 持股数量隐私保护
                <br>• 投资组合数据加密计算
                <br>• 同态加密确保数据永不泄露
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalArtworks">0</div>
                <div>艺术品总数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalInvestors">0</div>
                <div>投资者总数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="userPortfolio">0</div>
                <div>我的投资组合</div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h3>👤 投资者注册</h3>

                <div class="tabs">
                    <div class="tab active" onclick="showTab('register')">注册投资者</div>
                    <div class="tab" onclick="showTab('invest')">私密投资</div>
                </div>

                <div class="tab-content active" id="register">
                    <div class="form-group">
                        <button class="btn" onclick="registerInvestor()">注册为投资者</button>
                    </div>
                    <div id="registerStatus"></div>
                </div>

                <div class="tab-content" id="invest">
                    <div style="background: #e6f3ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85em; color: #2c5aa0;">
                        <strong>🔐 隐私保护投资</strong><br>
                        您的投资金额和持股数量将通过FHE技术完全加密，确保投资隐私。
                    </div>
                    <div class="form-group">
                        <label>选择艺术品:</label>
                        <select id="artworkSelect">
                            <option value="">选择要投资的艺术品...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>投资份额 🔐:</label>
                        <input type="number" id="shareAmount" placeholder="输入要购买的份额数量（将被加密）" min="1">
                    </div>
                    <div class="form-group">
                        <label>投资金额 (ETH) 🔐:</label>
                        <input type="text" id="investmentAmount" placeholder="将自动计算（加密存储）" readonly>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="makeInvestment()">🔐 进行私密投资</button>
                    </div>
                    <div id="investStatus"></div>
                </div>
            </div>

            <div class="card">
                <h3>🎭 艺术品管理</h3>

                <div class="form-group">
                    <label>艺术品名称:</label>
                    <input type="text" id="artworkName" placeholder="输入艺术品名称">
                </div>
                <div class="form-group">
                    <label>艺术家:</label>
                    <input type="text" id="artistName" placeholder="输入艺术家名称">
                </div>
                <div class="form-group">
                    <label>IPFS哈希:</label>
                    <input type="text" id="ipfsHash" placeholder="输入艺术品IPFS哈希">
                </div>
                <div class="form-group">
                    <label>总价值 (ETH):</label>
                    <input type="number" id="totalValue" placeholder="0.0" step="0.001">
                </div>
                <div class="form-group">
                    <label>每股价格 (ETH):</label>
                    <input type="number" id="sharePrice" placeholder="0.0" step="0.001">
                </div>
                <div class="form-group">
                    <label>总股数:</label>
                    <input type="number" id="totalShares" placeholder="100" min="1">
                </div>
                <div class="form-group">
                    <button class="btn" onclick="listArtwork()">上架艺术品</button>
                </div>
                <div id="listingStatus"></div>
            </div>
        </div>

        <div class="card artwork-gallery">
            <h3>🎨 艺术品画廊</h3>
            <div class="artworks-grid" id="artworksGrid">
                <div class="artwork-card">
                    <div class="artwork-image">🎨</div>
                    <div class="artwork-info">
                        <div class="artwork-title">暂无艺术品</div>
                        <div class="artwork-artist">请先上架艺术品</div>
                        <div class="artwork-stats">
                            <div class="stat">
                                <div class="stat-value">-</div>
                                <div class="stat-label">总价值</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">-</div>
                                <div class="stat-label">可用股数</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">-</div>
                                <div class="stat-label">投资人数</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-6.7.1.umd.min.js"></script>
    <script>
        let provider;
        let signer;
        let contract;
        let userAddress;

        const CONTRACT_ADDRESS = "0xa0eE56B7697846877d0E90FA654377dcDD68Aaa8"; // 替换为实际合约地址
        const CONTRACT_ABI = [
            "function registerInvestor() external",
            "function listArtwork(string memory _name, string memory _artist, string memory _ipfsHash, uint256 _totalValue, uint256 _sharePrice, uint256 _totalShares) external",
            "function makePrivateInvestment(uint256 artworkId, uint32 shareAmount) external payable",
            "function requestReturnsDistribution(uint256 artworkId) external payable",
            "function getArtworkInfo(uint256 artworkId) external view returns (string memory name, string memory artist, string memory ipfsHash, uint256 totalValue, uint256 sharePrice, uint256 totalShares, uint256 availableShares, uint256 investorCount)",
            "function getTotalStats() external view returns (uint256 totalArtworksListed, uint256 totalRegisteredInvestors)",
            "function isInvestorRegistered(address investor) external view returns (bool)",
            "function getInvestmentStatus(address investor, uint256 artworkId) external view returns (bool hasInvested, uint256 timestamp)",
            "function owner() external view returns (address)",
            "event ArtworkListed(uint256 indexed artworkId, string name, uint256 totalValue, uint256 sharePrice)",
            "event PrivateInvestmentMade(address indexed investor, uint256 indexed artworkId, uint256 timestamp)",
            "event InvestorRegistered(address indexed investor, uint256 timestamp)",
            "event ReturnsDistributed(uint256 indexed artworkId, uint256 totalReturns)"
        ];

        async function initWeb3() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    updateConnectionStatus(true);
                    await loadStats();
                    await loadArtworks();
                } catch (error) {
                    console.error("连接钱包失败:", error);
                    showStatus('registerStatus', `连接失败: ${error.message}`, 'error');
                }
            } else {
                showStatus('registerStatus', '请安装MetaMask钱包', 'error');
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = `已连接: ${userAddress?.substring(0, 6)}...${userAddress?.substring(38)}`;
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = '未连接';
                statusElement.className = 'connection-status';
            }
        }

        async function registerInvestor() {
            try {
                if (!contract) {
                    await initWeb3();
                }

                showStatus('registerStatus', '正在注册投资者...', 'info');

                const isRegistered = await contract.isInvestorRegistered(userAddress);
                if (isRegistered) {
                    showStatus('registerStatus', '您已经是注册投资者', 'info');
                    return;
                }

                const tx = await contract.registerInvestor();
                showStatus('registerStatus', `交易已提交: ${tx.hash}`, 'info');

                await tx.wait();
                showStatus('registerStatus', '投资者注册成功!', 'success');

                await loadStats();
            } catch (error) {
                console.error('注册失败:', error);
                showStatus('registerStatus', `注册失败: ${error.message}`, 'error');
            }
        }

        async function listArtwork() {
            try {
                if (!contract) {
                    await initWeb3();
                }

                const name = document.getElementById('artworkName').value;
                const artist = document.getElementById('artistName').value;
                const ipfsHash = document.getElementById('ipfsHash').value;
                const totalValue = document.getElementById('totalValue').value;
                const sharePrice = document.getElementById('sharePrice').value;
                const totalShares = document.getElementById('totalShares').value;

                if (!name || !artist || !ipfsHash || !totalValue || !sharePrice || !totalShares) {
                    showStatus('listingStatus', '请填写所有字段', 'error');
                    return;
                }

                const totalValueWei = ethers.parseEther(totalValue);
                const sharePriceWei = ethers.parseEther(sharePrice);

                showStatus('listingStatus', '正在上架艺术品...', 'info');

                const tx = await contract.listArtwork(name, artist, ipfsHash, totalValueWei, sharePriceWei, totalShares);
                showStatus('listingStatus', `交易已提交: ${tx.hash}`, 'info');

                await tx.wait();
                showStatus('listingStatus', '艺术品上架成功!', 'success');

                clearArtworkForm();
                await loadStats();
                await loadArtworks();
            } catch (error) {
                console.error('上架失败:', error);
                showStatus('listingStatus', `上架失败: ${error.message}`, 'error');
            }
        }

        async function makeInvestment() {
            try {
                if (!contract) {
                    await initWeb3();
                }

                const artworkId = document.getElementById('artworkSelect').value;
                const shareAmount = document.getElementById('shareAmount').value;

                if (!artworkId || !shareAmount) {
                    showStatus('investStatus', '请选择艺术品和输入份额数量', 'error');
                    return;
                }

                const isRegistered = await contract.isInvestorRegistered(userAddress);
                if (!isRegistered) {
                    showStatus('investStatus', '请先注册为投资者', 'error');
                    return;
                }

                showStatus('investStatus', '正在进行投资...', 'info');

                const artworkInfo = await contract.getArtworkInfo(artworkId);
                const investmentValue = artworkInfo.sharePrice * BigInt(shareAmount);

                const tx = await contract.makePrivateInvestment(artworkId, shareAmount, {
                    value: investmentValue
                });

                showStatus('investStatus', `交易已提交: ${tx.hash}`, 'info');

                await tx.wait();
                showStatus('investStatus', '投资成功!', 'success');

                clearInvestmentForm();
                await loadStats();
                await loadArtworks();
            } catch (error) {
                console.error('投资失败:', error);
                showStatus('investStatus', `投资失败: ${error.message}`, 'error');
            }
        }

        async function loadStats() {
            try {
                if (!contract) return;

                const [totalArtworks, totalInvestors] = await contract.getTotalStats();

                document.getElementById('totalArtworks').textContent = totalArtworks.toString();
                document.getElementById('totalInvestors').textContent = totalInvestors.toString();

                // FHE版本中投资组合数据是加密的，显示为隐私保护状态
                if (userAddress) {
                    try {
                        const isRegistered = await contract.isInvestorRegistered(userAddress);
                        if (isRegistered) {
                            document.getElementById('userPortfolio').textContent = '🔐'; // 显示加密状态
                        } else {
                            document.getElementById('userPortfolio').textContent = '0';
                        }
                    } catch (error) {
                        console.error('获取用户投资组合失败:', error);
                        document.getElementById('userPortfolio').textContent = '0';
                    }
                } else {
                    document.getElementById('userPortfolio').textContent = '0';
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        async function loadArtworks() {
            try {
                if (!contract) return;

                const [totalArtworks] = await contract.getTotalStats();
                const artworksGrid = document.getElementById('artworksGrid');
                const artworkSelect = document.getElementById('artworkSelect');

                artworksGrid.innerHTML = '';
                artworkSelect.innerHTML = '<option value="">选择要投资的艺术品...</option>';

                for (let i = 0; i < totalArtworks; i++) {
                    try {
                        const artworkInfo = await contract.getArtworkInfo(i);

                        const artworkCard = createArtworkCard(i, artworkInfo);
                        artworksGrid.appendChild(artworkCard);

                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `${artworkInfo.name} - ${ethers.utils.formatEther(artworkInfo.sharePrice)} ETH/股`;
                        artworkSelect.appendChild(option);
                    } catch (error) {
                        console.error(`加载艺术品 ${i} 失败:`, error);
                    }
                }
            } catch (error) {
                console.error('加载艺术品失败:', error);
            }
        }

        function createArtworkCard(id, info) {
            const card = document.createElement('div');
            card.className = 'artwork-card';

            const totalValue = ethers.formatEther(info.totalValue);
            const sharePrice = ethers.formatEther(info.sharePrice);

            card.innerHTML = `
                <div class="artwork-image">🎨</div>
                <div class="artwork-info">
                    <div class="artwork-title">${info.name}</div>
                    <div class="artwork-artist">by ${info.artist}</div>
                    <div class="artwork-stats">
                        <div class="stat">
                            <div class="stat-value">${totalValue} ETH</div>
                            <div class="stat-label">总价值</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${info.availableShares.toString()}</div>
                            <div class="stat-label">可用股数</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${info.investorCount.toString()}</div>
                            <div class="stat-label">投资人数</div>
                        </div>
                    </div>
                    <button class="invest-btn" onclick="selectArtworkForInvestment(${id})">
                        投资 (${sharePrice} ETH/股)
                    </button>
                </div>
            `;

            return card;
        }

        function selectArtworkForInvestment(artworkId) {
            document.getElementById('artworkSelect').value = artworkId;
            showTab('invest');

            // 自动计算投资金额
            calculateInvestmentAmount();
        }

        async function calculateInvestmentAmount() {
            const artworkId = document.getElementById('artworkSelect').value;
            const shareAmount = document.getElementById('shareAmount').value;

            if (artworkId && shareAmount && contract) {
                try {
                    const artworkInfo = await contract.getArtworkInfo(artworkId);
                    const totalAmount = artworkInfo.sharePrice * BigInt(shareAmount);
                    const formattedAmount = ethers.formatEther(totalAmount);

                    document.getElementById('investmentAmount').value = formattedAmount + ' ETH';
                } catch (error) {
                    console.error('计算投资金额失败:', error);
                }
            }
        }

        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearArtworkForm() {
            document.getElementById('artworkName').value = '';
            document.getElementById('artistName').value = '';
            document.getElementById('ipfsHash').value = '';
            document.getElementById('totalValue').value = '';
            document.getElementById('sharePrice').value = '';
            document.getElementById('totalShares').value = '';
        }

        function clearInvestmentForm() {
            document.getElementById('artworkSelect').value = '';
            document.getElementById('shareAmount').value = '';
            document.getElementById('investmentAmount').value = '';
        }

        // 事件监听器
        document.getElementById('shareAmount').addEventListener('input', calculateInvestmentAmount);
        document.getElementById('artworkSelect').addEventListener('change', calculateInvestmentAmount);

        // 页面加载时初始化
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                // 监听账户变化
                window.ethereum.on('accountsChanged', () => {
                    window.location.reload();
                });

                // 监听网络变化
                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

                await initWeb3();
            }
        });

        // 定期更新数据
        setInterval(async () => {
            if (contract) {
                await loadStats();
                await loadArtworks();
            }
        }, 30000); // 每30秒更新一次
    </script>
</body>
</html>